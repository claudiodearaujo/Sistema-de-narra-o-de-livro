generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========== AUTHENTICATION MODELS ==========

enum UserRole {
  USER
  WRITER
  ADMIN
}

enum AuthProvider {
  LOCAL
  GOOGLE
  GITHUB
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  password      String?      // Null for OAuth users
  name          String
  username      String?      @unique
  avatar        String?
  bio           String?
  role          UserRole     @default(USER)
  isVerified    Boolean      @default(false) @map("is_verified")
  
  // OAuth support (future)
  provider      AuthProvider @default(LOCAL)
  providerId    String?      @map("provider_id")
  
  // Email verification
  verifyToken   String?      @map("verify_token")
  verifyExpires DateTime?    @map("verify_expires")
  
  // Password reset
  resetToken    String?      @map("reset_token")
  resetExpires  DateTime?    @map("reset_expires")
  
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  
  // Relations
  books         Book[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ========== BOOK MODELS ==========

model Book {
  id          String    @id @default(uuid())
  title       String
  author      String
  description String?
  coverUrl    String?   @map("cover_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Owner relationship
  userId      String?   @map("user_id")
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  chapters    Chapter[]
  characters  Character[]

  @@index([userId])
  @@map("books")
}

model Chapter {
  id         String      @id @default(uuid())
  bookId     String      @map("book_id")
  title      String
  orderIndex Int         @map("order_index")
  status     String      @default("draft") // draft, in_progress, completed
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  book       Book        @relation(fields: [bookId], references: [id], onDelete: Cascade)
  speeches   Speech[]
  narration  Narration?

  @@map("chapters")
}

model Character {
  id              String   @id @default(uuid())
  bookId          String   @map("book_id")
  name            String
  voiceId         String   @map("voice_id")
  voiceDescription String? @map("voice_description")
  previewAudioUrl String?  @map("preview_audio_url")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  book            Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  speeches        Speech[]
  
  // Ficha completa - relações One-to-One
  identity        CharacterIdentity?
  physique        CharacterPhysique?
  face            CharacterFace?
  eyes            CharacterEyes?
  hair            CharacterHair?
  wardrobe        CharacterWardrobe?

  @@map("characters")
}

// ========== FICHA COMPLETA DO PERSONAGEM ==========

model CharacterIdentity {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  gender        String?   // Masculino, Feminino, Outro
  age           Int?
  nationality   String?
  occupation    String?
  birthDate     String?   @map("birth_date")
  birthPlace    String?   @map("birth_place")
  personality   String?   // Descrição da personalidade
  background    String?   // História de fundo
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_identities")
}

model CharacterPhysique {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  height        String?   // Ex: "1,70 m"
  weight        String?   // Ex: "60 kg"
  bodyType      String?   @map("body_type") // Magra, Atlética, Robusta, etc
  waist         String?   // Fina, Média, Larga
  posture       String?   // Erguida, Curvada, Relaxada
  skinTone      String?   @map("skin_tone") // Tom de pele
  skinTexture   String?   @map("skin_texture") // Textura da pele
  scars         String?   // Cicatrizes
  tattoos       String?   // Tatuagens
  birthmarks    String?   // Marcas de nascença
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_physiques")
}

model CharacterFace {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  faceShape     String?   @map("face_shape") // Oval, Redondo, Quadrado, etc
  forehead      String?   // Alta, Baixa, Lisa
  cheekbones    String?   // Salientes, Suaves
  chin          String?   // Afinado, Quadrado, Proeminente
  jaw           String?   // Mandíbula
  nose          String?   // Pequeno, Grande, Reto, Aquilino
  lips          String?   // Finos, Cheios, Simétricos
  expression    String?   // Expressão habitual
  beard         String?   // Para personagens masculinos
  mustache      String?   // Bigode
  wrinkles      String?   // Rugas
  dimples       String?   // Covinhas
  freckles      String?   // Sardas
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_faces")
}

model CharacterEyes {
  id              String    @id @default(uuid())
  characterId     String    @unique @map("character_id")
  eyeSize         String?   @map("eye_size") // Grandes, Pequenos, Médios
  eyeShape        String?   @map("eye_shape") // Amendoados, Redondos, Caídos
  eyeColor        String?   @map("eye_color") // Verde, Azul, Castanho, etc
  eyeSpacing      String?   @map("eye_spacing") // Afastados, Próximos
  eyelashes       String?   // Longos, Curtos, Grossos
  eyebrowShape    String?   @map("eyebrow_shape") // Arqueadas, Retas, Grossas
  eyebrowColor    String?   @map("eyebrow_color")
  eyebrowThickness String?  @map("eyebrow_thickness") // Finas, Médias, Grossas
  glasses         String?   // Tipo de óculos se usar
  makeup          String?   // Delineador, Sombra, etc
  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_eyes")
}

model CharacterHair {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  haircut       String?   // Tipo de corte
  hairLength    String?   @map("hair_length") // Curto, Médio, Longo
  hairColor     String?   @map("hair_color") // Cor natural ou tingido
  hairTexture   String?   @map("hair_texture") // Liso, Ondulado, Cacheado, Crespo
  hairVolume    String?   @map("hair_volume") // Volumoso, Ralo
  hairStyle     String?   @map("hair_style") // Estilo do penteado
  hairPart      String?   @map("hair_part") // Risco: central, lateral
  hairShine     String?   @map("hair_shine") // Brilho
  dyedColor     String?   @map("dyed_color") // Se tingido, qual cor
  highlights    String?   // Mechas
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_hairs")
}

model CharacterWardrobe {
  id              String    @id @default(uuid())
  characterId     String    @unique @map("character_id")
  // Vestimenta principal
  clothingStyle   String?   @map("clothing_style") // Estilo geral: casual, formal, etc
  topwear         String?   // Parte de cima
  topwearColor    String?   @map("topwear_color")
  topwearBrand    String?   @map("topwear_brand")
  bottomwear      String?   // Parte de baixo
  bottomwearColor String?   @map("bottomwear_color")
  bottomwearBrand String?   @map("bottomwear_brand")
  dress           String?   // Vestido (se aplicável)
  dressColor      String?   @map("dress_color")
  dressBrand      String?   @map("dress_brand")
  // Calçados
  footwear        String?   // Tipo de calçado
  footwearColor   String?   @map("footwear_color")
  footwearBrand   String?   @map("footwear_brand")
  heelHeight      String?   @map("heel_height") // Altura do salto
  // Acessórios
  earrings        String?   // Brincos
  necklace        String?   // Colares
  rings           String?   // Anéis
  bracelets       String?   // Pulseiras
  watch           String?   // Relógio
  bag             String?   // Bolsa
  hat             String?   // Chapéu/Boné
  scarf           String?   // Cachecol/Lenço
  // Detalhes
  nails           String?   // Unhas
  perfume         String?   // Perfume
  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_wardrobes")
}

model Speech {
  id          String   @id @default(uuid())
  chapterId   String   @map("chapter_id")
  characterId String   @map("character_id")
  text        String
  ssmlText    String?  @map("ssml_text")
  orderIndex  Int      @map("order_index")
  audioUrl    String?  @map("audio_url")
  chapter     Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("speeches")
}

model Narration {
  id          String   @id @default(uuid())
  chapterId   String   @unique @map("chapter_id")
  status      String   // pending, processing, completed, failed
  outputUrl   String?  @map("output_url")
  driveFileId String?  @map("drive_file_id")
  createdAt   DateTime @default(now()) @map("created_at")
  chapter     Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@map("narrations")
}

model CustomVoice {
  id          String   @id @default(uuid())
  name        String   @unique
  gender      String   // MALE, FEMALE, NEUTRAL
  languageCode String  @map("language_code")
  description String?
  provider    String   @default("custom")
  voiceId     String   @map("voice_id") // ID usado para referenciar a voz no TTS
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("custom_voices")
}
