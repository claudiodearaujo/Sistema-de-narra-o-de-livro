generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========== AUTHENTICATION MODELS ==========

enum UserRole {
  USER
  WRITER
  PRO
  ADMIN
}

enum SubscriptionPlan {
  FREE
  PREMIUM
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

enum PostType {
  TEXT
  IMAGE
  BOOK_UPDATE
  CHAPTER_PREVIEW
  AUDIO_PREVIEW
  POLL
  SHARED
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MENTION
  MESSAGE
  BOOK_UPDATE
  ACHIEVEMENT
  LIVRA_EARNED
  SYSTEM
}

enum LivraTransactionType {
  EARNED_LIKE
  EARNED_COMMENT
  EARNED_FOLLOW
  EARNED_POST
  EARNED_CAMPAIGN
  EARNED_PLAN
  EARNED_ACHIEVEMENT
  EARNED_PURCHASE
  SPENT_TTS
  SPENT_IMAGE
  SPENT_CHARACTER
  SPENT_BOOST
  EXPIRED
  ADMIN_ADJUSTMENT
}

enum AchievementCategory {
  WRITING
  SOCIAL
  READING
  MILESTONE
  SPECIAL
}

enum GroupRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum GroupPrivacy {
  PUBLIC
  PRIVATE
  INVITE_ONLY
}

enum StoryType {
  TEXT
  IMAGE
  QUOTE
  POLL
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum AuthProvider {
  LOCAL
  GOOGLE
  GITHUB
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  password      String?      // Null for OAuth users
  name          String
  username      String?      @unique
  avatar        String?
  bio           String?
  role          UserRole     @default(USER)
  isVerified    Boolean      @default(false) @map("is_verified")
  
  // OAuth support (future)
  provider      AuthProvider @default(LOCAL)
  providerId    String?      @map("provider_id")
  
  // Email verification
  verifyToken   String?      @map("verify_token")
  verifyExpires DateTime?    @map("verify_expires")
  
  // Password reset
  resetToken    String?      @map("reset_token")
  resetExpires  DateTime?    @map("reset_expires")
  
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  
  // Relations
  books         Book[]
  refreshTokens RefreshToken[]
  
  // Social relations
  posts           Post[]
  comments        Comment[]
  likes           Like[]
  followers       Follow[]       @relation("followers")
  following       Follow[]       @relation("following")
  sentMessages    Message[]      @relation("sentMessages")
  receivedMessages Message[]     @relation("receivedMessages")
  notifications   Notification[]
  
  // Gamification relations
  subscription      Subscription?
  livraBalance      LivraBalance?
  livraTransactions LivraTransaction[]
  achievements      UserAchievement[]
  
  // Groups relations
  ownedGroups       Group[]
  groupMemberships  GroupMember[]
  campaignProgress  CampaignProgress[]
  
  // Stories relations
  stories           Story[]
  storyViews        StoryView[]
  
  // Audit relations
  auditLogs         AuditLog[]

  // AI Usage relations
  aiUsageLogs       AIUsageLog[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ========== BOOK MODELS ==========

model Book {
  id          String    @id @default(uuid())
  title       String
  author      String
  description String?
  coverUrl    String?   @map("cover_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Owner relationship
  userId      String?   @map("user_id")
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  chapters    Chapter[]
  characters  Character[]
  posts       Post[]
  campaignBooks CampaignBook[]

  @@index([userId])
  @@map("books")
}

model Chapter {
  id         String      @id @default(uuid())
  bookId     String      @map("book_id")
  title      String
  orderIndex Int         @map("order_index")
  status     String      @default("draft") // draft, in_progress, completed
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  book       Book        @relation(fields: [bookId], references: [id], onDelete: Cascade)
  speeches   Speech[]
  narration  Narration?
  posts      Post[]
  campaignBooks CampaignBook[]

  @@map("chapters")
}

model Character {
  id              String   @id @default(uuid())
  bookId          String   @map("book_id")
  name            String
  voiceId         String   @map("voice_id")
  voiceDescription String? @map("voice_description")
  previewAudioUrl String?  @map("preview_audio_url")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  book            Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  speeches        Speech[]
  
  // Ficha completa - relações One-to-One
  identity        CharacterIdentity?
  physique        CharacterPhysique?
  face            CharacterFace?
  eyes            CharacterEyes?
  hair            CharacterHair?
  wardrobe        CharacterWardrobe?

  @@map("characters")
}

// ========== FICHA COMPLETA DO PERSONAGEM ==========

model CharacterIdentity {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  gender        String?   // Masculino, Feminino, Outro
  age           Int?
  nationality   String?
  occupation    String?
  birthDate     String?   @map("birth_date")
  birthPlace    String?   @map("birth_place")
  personality   String?   // Descrição da personalidade
  background    String?   // História de fundo
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_identities")
}

model CharacterPhysique {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  height        String?   // Ex: "1,70 m"
  weight        String?   // Ex: "60 kg"
  bodyType      String?   @map("body_type") // Magra, Atlética, Robusta, etc
  waist         String?   // Fina, Média, Larga
  posture       String?   // Erguida, Curvada, Relaxada
  skinTone      String?   @map("skin_tone") // Tom de pele
  skinTexture   String?   @map("skin_texture") // Textura da pele
  scars         String?   // Cicatrizes
  tattoos       String?   // Tatuagens
  birthmarks    String?   // Marcas de nascença
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_physiques")
}

model CharacterFace {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  faceShape     String?   @map("face_shape") // Oval, Redondo, Quadrado, etc
  forehead      String?   // Alta, Baixa, Lisa
  cheekbones    String?   // Salientes, Suaves
  chin          String?   // Afinado, Quadrado, Proeminente
  jaw           String?   // Mandíbula
  nose          String?   // Pequeno, Grande, Reto, Aquilino
  lips          String?   // Finos, Cheios, Simétricos
  expression    String?   // Expressão habitual
  beard         String?   // Para personagens masculinos
  mustache      String?   // Bigode
  wrinkles      String?   // Rugas
  dimples       String?   // Covinhas
  freckles      String?   // Sardas
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_faces")
}

model CharacterEyes {
  id              String    @id @default(uuid())
  characterId     String    @unique @map("character_id")
  eyeSize         String?   @map("eye_size") // Grandes, Pequenos, Médios
  eyeShape        String?   @map("eye_shape") // Amendoados, Redondos, Caídos
  eyeColor        String?   @map("eye_color") // Verde, Azul, Castanho, etc
  eyeSpacing      String?   @map("eye_spacing") // Afastados, Próximos
  eyelashes       String?   // Longos, Curtos, Grossos
  eyebrowShape    String?   @map("eyebrow_shape") // Arqueadas, Retas, Grossas
  eyebrowColor    String?   @map("eyebrow_color")
  eyebrowThickness String?  @map("eyebrow_thickness") // Finas, Médias, Grossas
  glasses         String?   // Tipo de óculos se usar
  makeup          String?   // Delineador, Sombra, etc
  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_eyes")
}

model CharacterHair {
  id            String    @id @default(uuid())
  characterId   String    @unique @map("character_id")
  haircut       String?   // Tipo de corte
  hairLength    String?   @map("hair_length") // Curto, Médio, Longo
  hairColor     String?   @map("hair_color") // Cor natural ou tingido
  hairTexture   String?   @map("hair_texture") // Liso, Ondulado, Cacheado, Crespo
  hairVolume    String?   @map("hair_volume") // Volumoso, Ralo
  hairStyle     String?   @map("hair_style") // Estilo do penteado
  hairPart      String?   @map("hair_part") // Risco: central, lateral
  hairShine     String?   @map("hair_shine") // Brilho
  dyedColor     String?   @map("dyed_color") // Se tingido, qual cor
  highlights    String?   // Mechas
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_hairs")
}

model CharacterWardrobe {
  id              String    @id @default(uuid())
  characterId     String    @unique @map("character_id")
  // Vestimenta principal
  clothingStyle   String?   @map("clothing_style") // Estilo geral: casual, formal, etc
  topwear         String?   // Parte de cima
  topwearColor    String?   @map("topwear_color")
  topwearBrand    String?   @map("topwear_brand")
  bottomwear      String?   // Parte de baixo
  bottomwearColor String?   @map("bottomwear_color")
  bottomwearBrand String?   @map("bottomwear_brand")
  dress           String?   // Vestido (se aplicável)
  dressColor      String?   @map("dress_color")
  dressBrand      String?   @map("dress_brand")
  // Calçados
  footwear        String?   // Tipo de calçado
  footwearColor   String?   @map("footwear_color")
  footwearBrand   String?   @map("footwear_brand")
  heelHeight      String?   @map("heel_height") // Altura do salto
  // Acessórios
  earrings        String?   // Brincos
  necklace        String?   // Colares
  rings           String?   // Anéis
  bracelets       String?   // Pulseiras
  watch           String?   // Relógio
  bag             String?   // Bolsa
  hat             String?   // Chapéu/Boné
  scarf           String?   // Cachecol/Lenço
  // Detalhes
  nails           String?   // Unhas
  perfume         String?   // Perfume
  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_wardrobes")
}

model Speech {
  id          String   @id @default(uuid())
  chapterId   String   @map("chapter_id")
  characterId String   @map("character_id")
  text        String
  ssmlText    String?  @map("ssml_text")
  orderIndex  Int      @map("order_index")
  audioUrl    String?  @map("audio_url")
  chapter     Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("speeches")
}

model Narration {
  id          String   @id @default(uuid())
  chapterId   String   @unique @map("chapter_id")
  status      String   // pending, processing, completed, failed
  outputUrl   String?  @map("output_url")
  driveFileId String?  @map("drive_file_id")
  createdAt   DateTime @default(now()) @map("created_at")
  chapter     Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@map("narrations")
}

model CustomVoice {
  id          String   @id @default(uuid())
  name        String   @unique
  gender      String   // MALE, FEMALE, NEUTRAL
  languageCode String  @map("language_code")
  description String?
  provider    String   @default("custom")
  voiceId     String   @map("voice_id") // ID usado para referenciar a voz no TTS
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("custom_voices")
}

// ========== SOCIAL MODELS ==========

model Post {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  type         PostType  @default(TEXT)
  content      String
  mediaUrl     String?   @map("media_url")
  bookId       String?   @map("book_id")
  chapterId    String?   @map("chapter_id")
  sharedPostId String?   @map("shared_post_id")
  likeCount    Int       @default(0) @map("like_count")
  commentCount Int       @default(0) @map("comment_count")
  shareCount   Int       @default(0) @map("share_count")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  book         Book?     @relation(fields: [bookId], references: [id], onDelete: SetNull)
  chapter      Chapter?  @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  sharedPost   Post?     @relation("SharedPosts", fields: [sharedPostId], references: [id], onDelete: SetNull)
  shares       Post[]    @relation("SharedPosts")
  comments     Comment[]
  likes        Like[]

  @@index([userId])
  @@index([bookId])
  @@index([createdAt])
  @@map("posts")
}

model Comment {
  id        String    @id @default(uuid())
  postId    String    @map("post_id")
  userId    String    @map("user_id")
  content   String
  parentId  String?   @map("parent_id")
  likeCount Int       @default(0) @map("like_count")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([postId])
  @@index([userId])
  @@map("comments")
}

model Like {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
  @@map("likes")
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  follower    User     @relation("following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

// ========== COMMUNICATION MODELS ==========

model Message {
  id         String   @id @default(uuid())
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  content    String
  isRead     Boolean  @default(false) @map("is_read")
  createdAt  DateTime @default(now()) @map("created_at")

  sender     User     @relation("sentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User     @relation("receivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("messages")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ========== GAMIFICATION MODELS ==========

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique @map("user_id")
  plan                 SubscriptionPlan   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  stripePriceId        String?            @map("stripe_price_id")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model LivraBalance {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  balance   Int      @default(0)
  lifetime  Int      @default(0) // Total earned ever
  spent     Int      @default(0) // Total spent ever
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("livra_balances")
}

model LivraTransaction {
  id        String               @id @default(uuid())
  userId    String               @map("user_id")
  type      LivraTransactionType
  amount    Int                  // Positive for earned, negative for spent
  balance   Int                  // Balance after transaction
  metadata  Json?
  expiresAt DateTime?            @map("expires_at")
  createdAt DateTime             @default(now()) @map("created_at")

  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("livra_transactions")
}

model LivraConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Int
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("livra_configs")
}

model LivraPackage {
  id            String   @id @default(uuid())
  name          String
  amount        Int      // Amount of Livras
  price         Int      // Price in cents
  stripePriceId String?  @map("stripe_price_id")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("livra_packages")
}

// ========== ACHIEVEMENT MODELS ==========

model Achievement {
  id          String              @id @default(uuid())
  key         String              @unique
  category    AchievementCategory
  name        String
  description String
  icon        String
  livraReward Int                 @default(0) @map("livra_reward")
  requirement Json?               // { type: 'count', target: 10 }
  isHidden    Boolean             @default(false) @map("is_hidden")
  createdAt   DateTime            @default(now()) @map("created_at")

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  achievementId String      @map("achievement_id")
  unlockedAt    DateTime    @default(now()) @map("unlocked_at")

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

// ========== GROUP MODELS ==========

model Group {
  id          String       @id @default(uuid())
  name        String
  description String?
  coverUrl    String?      @map("cover_url")
  ownerId     String       @map("owner_id")
  privacy     GroupPrivacy @default(PUBLIC)
  memberCount Int          @default(1) @map("member_count")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  owner       User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  campaigns   ReadingCampaign[]

  @@index([ownerId])
  @@map("groups")
}

model GroupMember {
  id       String    @id @default(uuid())
  groupId  String    @map("group_id")
  userId   String    @map("user_id")
  role     GroupRole @default(MEMBER)
  joinedAt DateTime  @default(now()) @map("joined_at")

  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
  @@map("group_members")
}

model ReadingCampaign {
  id          String         @id @default(uuid())
  groupId     String         @map("group_id")
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)
  startDate   DateTime?      @map("start_date")
  endDate     DateTime?      @map("end_date")
  livraReward Int            @default(0) @map("livra_reward")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  group       Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  books       CampaignBook[]
  progress    CampaignProgress[]

  @@index([groupId])
  @@map("reading_campaigns")
}

model CampaignBook {
  id         String          @id @default(uuid())
  campaignId String          @map("campaign_id")
  bookId     String          @map("book_id")
  chapterId  String?         @map("chapter_id")
  orderIndex Int             @default(0) @map("order_index")
  createdAt  DateTime        @default(now()) @map("created_at")

  campaign   ReadingCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  book       Book            @relation(fields: [bookId], references: [id], onDelete: Cascade)
  chapter    Chapter?        @relation(fields: [chapterId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@map("campaign_books")
}

model CampaignProgress {
  id          String          @id @default(uuid())
  campaignId  String          @map("campaign_id")
  userId      String          @map("user_id")
  booksRead   Int             @default(0) @map("books_read")
  isCompleted Boolean         @default(false) @map("is_completed")
  completedAt DateTime?       @map("completed_at")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  campaign    ReadingCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@map("campaign_progress")
}

// ========== STORY MODELS ==========

model Story {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  type      StoryType @default(TEXT)
  content   String?
  mediaUrl  String?   @map("media_url")
  expiresAt DateTime  @map("expires_at")
  viewCount Int       @default(0) @map("view_count")
  createdAt DateTime  @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  views     StoryView[]

  @@index([userId])
  @@index([expiresAt])
  @@map("stories")
}

model StoryView {
  id       String   @id @default(uuid())
  storyId  String   @map("story_id")
  userId   String   @map("user_id")
  viewedAt DateTime @default(now()) @map("viewed_at")

  story    Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@map("story_views")
}

// ========== AUDIT LOGGING MODELS ==========

enum AuditAction {
  // Autenticacao
  AUTH_LOGIN
  AUTH_LOGIN_FAILED
  AUTH_LOGOUT
  AUTH_LOGOUT_ALL
  AUTH_SIGNUP
  AUTH_TOKEN_REFRESH
  AUTH_PASSWORD_CHANGE
  AUTH_PASSWORD_RESET_REQUEST
  AUTH_PASSWORD_RESET_COMPLETE
  AUTH_EMAIL_VERIFY

  // Livros
  BOOK_CREATE
  BOOK_UPDATE
  BOOK_DELETE
  BOOK_VIEW

  // Capitulos
  CHAPTER_CREATE
  CHAPTER_UPDATE
  CHAPTER_DELETE
  CHAPTER_REORDER

  // Personagens
  CHARACTER_CREATE
  CHARACTER_UPDATE
  CHARACTER_DELETE

  // Falas / Dialogos
  SPEECH_CREATE
  SPEECH_UPDATE
  SPEECH_DELETE

  // Narracao e Audio
  NARRATION_START
  NARRATION_COMPLETE
  NARRATION_FAIL
  AUDIO_GENERATE
  AUDIO_DELETE

  // Social - Posts
  POST_CREATE
  POST_UPDATE
  POST_DELETE

  // Social - Comentarios
  COMMENT_CREATE
  COMMENT_DELETE

  // Social - Interacoes
  LIKE_TOGGLE
  FOLLOW_TOGGLE

  // Mensagens
  MESSAGE_SEND
  MESSAGE_DELETE

  // Perfil
  PROFILE_UPDATE
  AVATAR_UPLOAD

  // Grupos
  GROUP_CREATE
  GROUP_UPDATE
  GROUP_DELETE
  GROUP_JOIN
  GROUP_LEAVE
  GROUP_MEMBER_ROLE_CHANGE
  GROUP_MEMBER_REMOVE

  // Campanhas
  CAMPAIGN_CREATE
  CAMPAIGN_UPDATE
  CAMPAIGN_DELETE
  CAMPAIGN_JOIN

  // Stories
  STORY_CREATE
  STORY_DELETE

  // Financeiro / Assinatura
  SUBSCRIPTION_CREATE
  SUBSCRIPTION_CANCEL
  SUBSCRIPTION_UPGRADE
  SUBSCRIPTION_DOWNGRADE
  LIVRA_PURCHASE
  LIVRA_SPEND
  LIVRA_EARN

  // AI
  AI_TEXT_GENERATE
  AI_IMAGE_GENERATE
  AI_TTS_GENERATE

  // Admin
  ADMIN_USER_BAN
  ADMIN_USER_UNBAN
  ADMIN_USER_ROLE_CHANGE
  ADMIN_CONTENT_REMOVE
  ADMIN_CONFIG_CHANGE

  // Sistema
  RATE_LIMIT_EXCEEDED
  PERMISSION_DENIED
  PLAN_LIMIT_REACHED
}

enum AuditCategory {
  AUTH
  BOOK
  CHAPTER
  CHARACTER
  SPEECH
  NARRATION
  SOCIAL
  MESSAGE
  PROFILE
  GROUP
  CAMPAIGN
  STORY
  FINANCIAL
  AI
  ADMIN
  SYSTEM
}

enum AuditSeverity {
  LOW        // Acoes de leitura, visualizacao
  MEDIUM     // Acoes de criacao e edicao
  HIGH       // Acoes de delecao, mudanca de senha
  CRITICAL   // Acoes admin, financeiras, falhas de seguranca
}

model AuditLog {
  id          String         @id @default(uuid())

  // Quem
  userId      String?        // Null para acoes anonimas (login falho)
  user        User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail   String?        // Snapshot do email no momento da acao
  userRole    UserRole?      // Snapshot do role no momento da acao

  // O que
  action      AuditAction
  category    AuditCategory
  severity    AuditSeverity  @default(MEDIUM)

  // Onde
  resource    String?        // Tipo do recurso: "Book", "Chapter", "Post", etc.
  resourceId  String?        // ID do recurso afetado

  // Como
  method      String?        // HTTP method: GET, POST, PUT, DELETE
  endpoint    String?        // Rota da API: /api/books/:id
  statusCode  Int?           // HTTP status code da resposta

  // Detalhes
  metadata    Json?          // Dados adicionais (campos alterados, valores anteriores)
  description String?        // Descricao legivel da acao

  // Contexto de rede
  ipAddress   String?
  userAgent   String?
  sessionId   String?        // ID da sessao/refresh token

  // Resultado
  success     Boolean        @default(true)
  errorMessage String?       // Mensagem de erro se success = false

  // Tempo
  duration    Int?           // Duracao da operacao em ms
  createdAt   DateTime       @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@index([success])
  @@index([ipAddress])
  @@index([userId, createdAt])
  @@index([category, createdAt])
  @@index([action, createdAt])

  @@map("audit_logs")
}

// ========== AI USAGE TRACKING MODELS ==========

enum AIOperationType {
  TTS_GENERATE
  TTS_PREVIEW
  TTS_VOICES_LIST
  TEXT_GENERATE
  TEXT_SPELLCHECK
  TEXT_SUGGEST
  TEXT_ENRICH
  IMAGE_GENERATE
  IMAGE_EMOTION
  NARRATION_CHAPTER
}

enum AIProviderName {
  GEMINI
  ELEVENLABS
  OPENAI
  ANTHROPIC
  STABILITY
  AZURE
}

model AIUsageLog {
  id            String          @id @default(uuid())

  // Quem
  userId        String          @map("user_id")
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // O que
  operation     AIOperationType
  provider      AIProviderName

  // Contexto
  resourceType  String?         @map("resource_type")  // "Chapter", "Speech", "Character", etc.
  resourceId    String?         @map("resource_id")

  // Métricas de uso
  inputTokens   Int             @default(0) @map("input_tokens")   // Tokens/caracteres de entrada
  outputTokens  Int             @default(0) @map("output_tokens")  // Tokens/caracteres de saída
  inputChars    Int             @default(0) @map("input_chars")    // Caracteres de texto enviados
  outputBytes   Int             @default(0) @map("output_bytes")   // Bytes de saída (áudio/imagem)
  durationMs    Int             @default(0) @map("duration_ms")    // Duração da chamada em ms

  // Custo
  estimatedCost Float           @default(0) @map("estimated_cost") // Custo estimado em USD
  livrasCost    Int             @default(0) @map("livras_cost")    // Custo em Livras cobrado

  // Resultado
  success       Boolean         @default(true)
  errorMessage  String?         @map("error_message")

  // Metadados
  metadata      Json?           // Dados extras (modelo usado, voz, formato, etc.)

  createdAt     DateTime        @default(now()) @map("created_at")

  @@index([userId])
  @@index([operation])
  @@index([provider])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId, operation])
  @@index([provider, createdAt])

  @@map("ai_usage_logs")
}
